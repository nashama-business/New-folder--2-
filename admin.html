<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - نشامى الأعمال</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin specific styles */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .delete-btn {
            color: var(--danger);
            cursor: pointer;
        }

        .edit-btn {
            color: var(--primary-color);
            cursor: pointer;
            margin-left: 10px;
        }
    </style>
</head>

<body>

    <!-- Authentication Overlay -->
    <div id="auth-overlay" class="login-overlay">
        <div class="login-box">
            <h2>تسجيل الدخول</h2>
            <p>أدخل كلمة المرور للوصول إلى لوحة التحكم</p>
            <div class="form-group">
                <input type="password" id="password-input" class="form-control" placeholder="كلمة المرور">
            </div>
            <button onclick="checkAuth()" class="btn">دخول</button>
            <p id="auth-error" class="text-danger mt-2 hidden">كلمة المرور غير صحيحة!</p>
        </div>
    </div>

    <div class="admin-container" id="admin-panel" style="display:none;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h2>لوحة التحكم</h2>
            <ul>
                <li><a href="#" onclick="showTab('dashboard')" class="active">الرئيسية</a></li>
                <li><a href="#" onclick="showTab('structure')">الهيكل التنظيمي</a></li>
                <li><a href="#" onclick="showTab('staff')">الهيئة التدريسية</a></li>
                <li><a href="#" onclick="showTab('facilities')">المرافق</a></li>
                <li><a href="#" onclick="showTab('materials')">المواد الدراسية</a></li>
                <li><a href="index.html" target="_blank">عرض الموقع</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">

            <!-- Header Actions -->
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
                <button onclick="DB.export()" class="btn" style="background-color: var(--success); color: white;">تصدير
                    البيانات (JSON)</button>
                <input type="file" id="import-file" style="display: none;" onchange="DB.import(this.files[0])">
                <button onclick="document.getElementById('import-file').click()" class="btn"
                    style="background-color: var(--primary-color); color: white;">استيراد بيانات</button>
                <button onclick="DB.reset()" class="btn" style="background-color: var(--danger); color: white;">إعادة
                    ضبط</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h3>إحصائيات الموقع</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="count-staff">0</div>
                        <div>عضو هيئة تدريس</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="count-students">0</div> <!-- Placeholder -->
                        <div>طالب (تجريبي)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="count-facilities">0</div>
                        <div>مرفق</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="count-materials">0</div>
                        <div>مادة دراسية</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h3>شريط الأخبار العاجلة</h3>
                        <div class="form-group">
                            <label>نص الخبر:</label>
                            <input type="text" id="news-text" class="form-control">
                        </div>
                        <button onclick="saveNews()" class="btn">حفظ التغييرات</button>
                    </div>
                </div>
            </div>

            <!-- Structure Tab -->
            <div id="structure" class="tab-content">
                <h3>إدارة الأقسام والتخصصات</h3>

                <div class="grid">
                    <!-- Departments -->
                    <div class="card">
                        <div class="card-body">
                            <h4>الأقسام</h4>
                            <div class="form-group">
                                <input type="text" id="new-dept-name" class="form-control"
                                    placeholder="اسم القسم الجديد">
                            </div>
                            <button onclick="addDepartment()" class="btn mb-2">إضافة قسم</button>
                            <ul id="dept-list"></ul>
                        </div>
                    </div>

                    <!-- Majors -->
                    <div class="card">
                        <div class="card-body">
                            <h4>التخصصات</h4>
                            <div class="form-group">
                                <select id="major-dept-select" class="form-control mb-2"></select>
                                <input type="text" id="new-major-name" class="form-control"
                                    placeholder="اسم التخصص الجديد">
                            </div>
                            <button onclick="addMajor()" class="btn mb-2">إضافة تخصص</button>
                            <ul id="major-list"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Staff Tab -->
            <div id="staff" class="tab-content">
                <h3>إدارة الهيئة التدريسية</h3>

                <div class="card mb-2">
                    <div class="card-body">
                        <h4>إضافة / تعديل عضو</h4>
                        <input type="hidden" id="staff-id">
                        <div class="grid" style="grid-template-columns: 1fr 1fr; margin: 10px 0;">
                            <div class="form-group">
                                <label>الاسم:</label>
                                <input type="text" id="staff-name" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>البريد الإلكتروني:</label>
                                <input type="email" id="staff-email" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>الرتبة الأكاديمية:</label>
                                <select id="staff-rank" class="form-control">
                                    <option value="أستاذ دكتور">أستاذ دكتور</option>
                                    <option value="أستاذ مشارك">أستاذ مشارك</option>
                                    <option value="أستاذ مساعد">أستاذ مساعد</option>
                                    <option value="مدرس">مدرس</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>القسم:</label>
                                <select id="staff-dept" class="form-control"></select>
                            </div>
                            <div class="form-group">
                                <label>رابط الصورة:</label>
                                <input type="text" id="staff-image" class="form-control" placeholder="https://...">
                            </div>
                        </div>

                        <h4>الموقع</h4>
                        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; margin: 10px 0;">
                            <input type="text" id="staff-building" class="form-control" placeholder="المبنى">
                            <input type="text" id="staff-floor" class="form-control" placeholder="الطابق">
                            <input type="text" id="staff-office" class="form-control" placeholder="المكتب">
                        </div>

                        <h4>الساعات المكتبية</h4>
                        <div class="grid" style="grid-template-columns: repeat(5, 1fr); gap: 5px; margin: 10px 0;">
                            <input type="text" id="oh-sun" class="form-control" placeholder="الأحد">
                            <input type="text" id="oh-mon" class="form-control" placeholder="الاثنين">
                            <input type="text" id="oh-tue" class="form-control" placeholder="الثلاثاء">
                            <input type="text" id="oh-wed" class="form-control" placeholder="الأربعاء">
                            <input type="text" id="oh-thu" class="form-control" placeholder="الخميس">
                        </div>

                        <button onclick="saveStaff()" class="btn">حفظ البيانات</button>
                        <button onclick="clearStaffForm()" class="btn"
                            style="background-color: #6c757d; color: white;">مسح النموذج</button>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>القسم</th>
                            <th>الرتبة</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="staff-table-body"></tbody>
                </table>
            </div>

            <!-- Facilities Tab -->
            <div id="facilities" class="tab-content">
                <h3>إدارة المرافق</h3>
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="grid" style="grid-template-columns: 1fr 1fr; margin: 10px 0;">
                            <input type="text" id="fac-name" class="form-control" placeholder="اسم المرفق">
                            <input type="text" id="fac-cat" class="form-control"
                                placeholder="الفئة (مثال: قاعات، مختبرات)">
                            <input type="text" id="fac-image" class="form-control" placeholder="رابط الصورة">
                            <input type="text" id="fac-desc" class="form-control" placeholder="الوصف">
                            <input type="text" id="fac-building" class="form-control" placeholder="المبنى">
                            <input type="text" id="fac-floor" class="form-control" placeholder="الطابق">
                        </div>
                        <button onclick="addFacility()" class="btn">إضافة مرفق</button>
                    </div>
                </div>
                <ul id="facilities-list"></ul>
            </div>

            <!-- Materials Tab -->
            <div id="materials" class="tab-content">
                <h3>إدارة المواد الدراسية</h3>
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="grid" style="grid-template-columns: 1fr 1fr; margin: 10px 0;">
                            <input type="text" id="mat-name" class="form-control" placeholder="اسم المادة">
                            <select id="mat-major" class="form-control"></select>
                            <input type="text" id="mat-link" class="form-control" placeholder="رابط قوقل درايف">
                            <input type="text" id="mat-syllabus" class="form-control" placeholder="رابط الخطة الدراسية">
                        </div>
                        <button onclick="addMaterial()" class="btn">إضافة مادة</button>
                    </div>
                </div>
                <ul id="materials-list"></ul>
            </div>

        </main>
    </div>

    <script src="script.js"></script>
    <script>
        // Auth
        function checkAuth() {
            const pass = document.getElementById('password-input').value;
            if (pass === '1234') {
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'flex';
                initAdmin();
            } else {
                document.getElementById('auth-error').classList.remove('hidden');
            }
        }

        // Tabs
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Init Admin
        function initAdmin() {
            renderDashboard();
            renderStructure();
            renderStaff();
            renderFacilities();
            renderMaterials();
        }

        // --- Dashboard ---
        function renderDashboard() {
            document.getElementById('count-staff').textContent = window.appData.staff.length;
            document.getElementById('count-facilities').textContent = window.appData.facilities.length;
            document.getElementById('count-materials').textContent = window.appData.materials.length;
            document.getElementById('news-text').value = window.appData.site_settings.news_text;
        }

        function saveNews() {
            window.appData.site_settings.news_text = document.getElementById('news-text').value;
            DB.save(window.appData);
            alert('تم حفظ الخبر!');
        }

        // --- Structure ---
        function renderStructure() {
            // Departments
            const deptList = document.getElementById('dept-list');
            deptList.innerHTML = window.appData.departments.map(d =>
                `<li>${d.name} <span class="delete-btn" onclick="deleteItem('departments', ${d.id})">❌</span></li>`
            ).join('');

            // Majors
            const majorSelect = document.getElementById('major-dept-select');
            majorSelect.innerHTML = window.appData.departments.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

            const majorList = document.getElementById('major-list');
            majorList.innerHTML = window.appData.majors.map(m =>
                `<li>${m.name} (${Helpers.getDeptName(m.department_id, window.appData.departments)}) <span class="delete-btn" onclick="deleteItem('majors', ${m.id})">❌</span></li>`
            ).join('');
        }

        function addDepartment() {
            const name = document.getElementById('new-dept-name').value;
            if (!name) return;
            window.appData.departments.push({ id: Helpers.generateId(window.appData.departments), name });
            DB.save(window.appData);
            renderStructure();
            document.getElementById('new-dept-name').value = '';
        }

        function addMajor() {
            const name = document.getElementById('new-major-name').value;
            const deptId = document.getElementById('major-dept-select').value;
            if (!name) return;
            window.appData.majors.push({ id: Helpers.generateId(window.appData.majors), name, department_id: parseInt(deptId) });
            DB.save(window.appData);
            renderStructure();
            document.getElementById('new-major-name').value = '';
        }

        // --- Staff ---
        function renderStaff() {
            const deptSelect = document.getElementById('staff-dept');
            deptSelect.innerHTML = window.appData.departments.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

            const tbody = document.getElementById('staff-table-body');
            tbody.innerHTML = window.appData.staff.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td>${Helpers.getDeptName(s.department_id, window.appData.departments)}</td>
                    <td>${s.academic_rank}</td>
                    <td>
                        <span class="edit-btn" onclick="editStaff(${s.id})">✏️</span>
                        <span class="delete-btn" onclick="deleteItem('staff', ${s.id})">❌</span>
                    </td>
                </tr>
            `).join('');
        }

        function saveStaff() {
            const id = document.getElementById('staff-id').value;
            const staffData = {
                id: id ? parseInt(id) : Helpers.generateId(window.appData.staff),
                name: document.getElementById('staff-name').value,
                email: document.getElementById('staff-email').value,
                academic_rank: document.getElementById('staff-rank').value,
                department_id: parseInt(document.getElementById('staff-dept').value),
                image: document.getElementById('staff-image').value,
                building: document.getElementById('staff-building').value,
                floor: document.getElementById('staff-floor').value,
                office: document.getElementById('staff-office').value,
                office_hours: {
                    sun: document.getElementById('oh-sun').value,
                    mon: document.getElementById('oh-mon').value,
                    tue: document.getElementById('oh-tue').value,
                    wed: document.getElementById('oh-wed').value,
                    thu: document.getElementById('oh-thu').value
                }
            };

            if (id) {
                const index = window.appData.staff.findIndex(s => s.id == id);
                window.appData.staff[index] = staffData;
            } else {
                window.appData.staff.push(staffData);
            }

            DB.save(window.appData);
            renderStaff();
            renderDashboard(); // Update count
            clearStaffForm();
            alert('تم حفظ بيانات المدرس');
        }

        function editStaff(id) {
            const s = window.appData.staff.find(item => item.id == id);
            if (!s) return;
            document.getElementById('staff-id').value = s.id;
            document.getElementById('staff-name').value = s.name;
            document.getElementById('staff-email').value = s.email;
            document.getElementById('staff-rank').value = s.academic_rank;
            document.getElementById('staff-dept').value = s.department_id;
            document.getElementById('staff-image').value = s.image;
            document.getElementById('staff-building').value = s.building;
            document.getElementById('staff-floor').value = s.floor;
            document.getElementById('staff-office').value = s.office;

            document.getElementById('oh-sun').value = s.office_hours.sun;
            document.getElementById('oh-mon').value = s.office_hours.mon;
            document.getElementById('oh-tue').value = s.office_hours.tue;
            document.getElementById('oh-wed').value = s.office_hours.wed;
            document.getElementById('oh-thu').value = s.office_hours.thu;
        }

        function clearStaffForm() {
            document.getElementById('staff-id').value = '';
            document.querySelectorAll('#staff input').forEach(i => i.value = '');
        }

        // --- Facilities ---
        function renderFacilities() {
            // No category select to populate anymore
            const list = document.getElementById('facilities-list');
            list.innerHTML = window.appData.facilities.map(f => `
                <li>${f.name} (${f.category}) <span class="delete-btn" onclick="deleteItem('facilities', ${f.id})">❌</span></li>
            `).join('');
        }

        function addFacility() {
            const name = document.getElementById('fac-name').value;
            const category = document.getElementById('fac-cat').value;
            if (!name || !category) {
                alert('الرجاء إدخال الاسم والفئة');
                return;
            }
            const fac = {
                id: Helpers.generateId(window.appData.facilities),
                name: name,
                category: category,
                image: document.getElementById('fac-image').value,
                description: document.getElementById('fac-desc').value,
                building: document.getElementById('fac-building').value,
                floor: document.getElementById('fac-floor').value
            };
            window.appData.facilities.push(fac);
            DB.save(window.appData);
            renderFacilities();
            renderDashboard();
            document.querySelectorAll('#facilities input').forEach(i => i.value = '');
        }

        // --- Materials ---
        function renderMaterials() {
            const majorSelect = document.getElementById('mat-major');
            majorSelect.innerHTML = window.appData.majors.map(m => `<option value="${m.id}">${m.name}</option>`).join('');

            const list = document.getElementById('materials-list');
            list.innerHTML = window.appData.materials.map(m => `
                <li>${m.name} <span class="delete-btn" onclick="deleteItem('materials', ${m.id})">❌</span></li>
            `).join('');
        }

        function addMaterial() {
            const name = document.getElementById('mat-name').value;
            if (!name) return;
            const mat = {
                id: Helpers.generateId(window.appData.materials),
                name: name,
                major_id: parseInt(document.getElementById('mat-major').value),
                link: document.getElementById('mat-link').value,
                syllabus_url: document.getElementById('mat-syllabus').value
            };
            window.appData.materials.push(mat);
            DB.save(window.appData);
            renderMaterials();
            renderDashboard();
            document.querySelectorAll('#materials input').forEach(i => i.value = '');
        }

        // --- Generic Delete ---
        function deleteItem(collectionName, id) {
            if (!confirm('هل أنت متأكد من الحذف؟')) return;
            window.appData[collectionName] = window.appData[collectionName].filter(item => item.id !== id);
            DB.save(window.appData);
            initAdmin(); // Re-render all
        }

    </script>
</body>

</html>